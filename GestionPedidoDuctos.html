<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Pedidos Local</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        /* Estilos para las animaciones y el modal */
        .fade-in { animation: fadeIn 0.3s ease-out; }
        .fade-out { animation: fadeOut 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body class="p-4 md:p-8 flex flex-col items-center">

    <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl w-full max-w-5xl transition-all duration-300">
        <header class="flex items-center justify-center mb-6 md:mb-8 text-center">
              <svg class="h-10 w-10 text-indigo-600 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C6.34 4.01 5.5 4.973 5.5 6.108V18.75c0 1.242.828 2.25 2.05 2.25H18A2.25 2.25 0 0020.25 18.75V9.75M9 12h3.75" />
            </svg>
            <h1 class="text-3xl font-bold text-indigo-600">Gestor de Pedidos Aires</h1>
        </header>
        
        <form id="orderForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 border-b pb-6 border-gray-200">
            <div>
                <label for="nroPedido" class="block text-sm font-medium text-gray-700">Nro de Pedido</label>
                <input type="text" id="nroPedido" name="nroPedido" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 transition-colors p-2.5">
            </div>
            <div>
                <label for="descripcion" class="block text-sm font-medium text-gray-700">Descripción</label>
                <select id="descripcion" name="descripcion" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 transition-colors p-2.5">
                    <option value="" disabled selected>Selecciona una opción</option>
                    <option value="TRAMO RECTO">TRAMO RECTO</option>
                    <option value="CURVA 90°">CURVA 90°</option>
                    <option value="CURVA 45°">CURVA 45°</option>
                    <option value="TRANSFORMACIÓN">TRANSFORMACIÓN</option>
                    <option value="PANTALÓN">PANTALÓN</option>
                    <option value="CUÑA">CUÑA</option>
                    <option value="COLLARIN">COLLARIN</option>
                    <option value="OTRO">OTRO</option>
                </select>
            </div>
            <div>
                <label for="cantidad" class="block text-sm font-medium text-gray-700">Cantidad</label>
                <input type="number" id="cantidad" name="cantidad" required min="1" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 transition-colors p-2.5">
            </div>
            <div>
                <label for="observacion" class="block text-sm font-medium text-gray-700">Observación</label>
                <input type="text" id="observacion" name="observacion" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 transition-colors p-2.5">
            </div>
            <div class="col-span-1 md:col-span-2 lg:col-span-4 mt-2">
                <button type="submit" id="submitButton" class="w-full py-2.5 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-transform transform hover:scale-105">Agregar Pedido</button>
            </div>
        </form>

        <div id="statusMessage" class="hidden p-3 mb-4 rounded-lg text-center transition-all duration-300"></div>
        
        <div class="mb-4">
            <label for="searchInput" class="sr-only">Buscar pedidos</label>
            <input type="text" id="searchInput" placeholder="Buscar por Nro de Pedido o Descripción..." class="w-full p-2.5 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 transition-colors">
        </div>

        <div class="overflow-x-auto rounded-lg shadow-inner bg-gray-50/50">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tl-lg">Nro de Pedido</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Cantidad</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Observación</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha de Creación</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider rounded-tr-lg">Acciones</th>
                    </tr>
                </thead>
                <tbody id="ordersTableBody" class="bg-white divide-y divide-gray-200">
                    <!-- Las filas de los pedidos se insertarán aquí -->
                </tbody>
            </table>
             <div id="emptyState" class="hidden p-8 text-center text-gray-500">
                  <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                      <path vector-effect="non-scaling-stroke" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9 1V7a2 2 0 012-2h4l2 2h4a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
                  </svg>
                  <h3 class="mt-2 text-sm font-medium text-gray-900">No hay pedidos</h3>
                  <p class="mt-1 text-sm text-gray-500">Empieza agregando un nuevo pedido usando el formulario.</p>
              </div>
        </div>

        <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mt-8 justify-between">
            <button id="exportPdfBtn" class="py-2.5 px-4 rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:scale-105 flex items-center justify-center space-x-2">
                 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                <span>Exportar a PDF</span>
            </button>
            <button id="clearAllBtn" class="py-2.5 px-4 rounded-lg shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-transform transform hover:scale-105 flex items-center justify-center space-x-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                <span>Limpiar Todo</span>
            </button>
        </div>
    </div>
    
    <!-- Modal de Confirmación -->
    <div id="confirmationModal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay hidden">
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 fade-in">
            <h3 class="text-lg font-bold text-gray-900">Confirmar Acción</h3>
            <p id="modalMessage" class="mt-2 text-sm text-gray-600">¿Estás seguro de que quieres realizar esta acción?</p>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancelButton" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm font-medium transition">Cancelar</button>
                <button id="confirmButton" class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white text-sm font-medium transition">Confirmar</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ELEMENTOS DEL DOM
            const orderForm = document.getElementById('orderForm');
            const submitButton = document.getElementById('submitButton');
            const ordersTableBody = document.getElementById('ordersTableBody');
            const searchInput = document.getElementById('searchInput');
            const exportPdfBtn = document.getElementById('exportPdfBtn');
            const clearAllBtn = document.getElementById('clearAllBtn');
            const statusMessage = document.getElementById('statusMessage');
            const emptyState = document.getElementById('emptyState');
            
            // Modal
            const confirmationModal = document.getElementById('confirmationModal');
            const modalMessage = document.getElementById('modalMessage');
            const confirmButton = document.getElementById('confirmButton');
            const cancelButton = document.getElementById('cancelButton');


            // ESTADO DE LA APLICACIÓN
            let orders = [];
            let editingOrderId = null;
            let actionToConfirm = null;

            // FUNCIONES

            // Cargar pedidos desde Local Storage
            const loadOrders = () => {
                const storedOrders = localStorage.getItem('orders');
                orders = storedOrders ? JSON.parse(storedOrders) : [];
                renderOrders(orders);
            };

            // Guardar pedidos en Local Storage
            const saveOrders = () => {
                localStorage.setItem('orders', JSON.stringify(orders));
            };
            
            // Mostrar mensaje de estado
            const showStatusMessage = (message, type = 'success') => {
                statusMessage.textContent = message;
                statusMessage.className = `p-3 mb-4 rounded-lg text-center transition-all duration-300 ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
                statusMessage.classList.remove('hidden');
                setTimeout(() => {
                    statusMessage.classList.add('hidden');
                }, 3000);
            };

            // Renderizar la tabla de pedidos
            const renderOrders = (ordersToRender) => {
                ordersTableBody.innerHTML = '';
                if (ordersToRender.length === 0) {
                    emptyState.classList.remove('hidden');
                } else {
                    emptyState.classList.add('hidden');
                }
                
                ordersToRender.forEach(order => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-50 transition-colors';
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${order.nroPedido}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.descripcion}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.cantidad}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.observacion || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(order.createdAt).toLocaleDateString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                            <button data-id="${order.id}" class="edit-btn text-indigo-600 hover:text-indigo-900 transition">Editar</button>
                            <button data-id="${order.id}" class="delete-btn text-red-600 hover:text-red-900 transition">Eliminar</button>
                        </td>
                    `;
                    ordersTableBody.appendChild(tr);
                });
            };
            
            // Manejar envío del formulario (Crear y Actualizar)
            const handleFormSubmit = (e) => {
                e.preventDefault();
                const formData = new FormData(orderForm);
                const orderData = Object.fromEntries(formData.entries());

                if (editingOrderId) {
                    // Actualizar pedido existente
                    const index = orders.findIndex(order => order.id === editingOrderId);
                    if (index !== -1) {
                        orders[index] = { ...orders[index], ...orderData };
                    }
                    showStatusMessage('Pedido actualizado correctamente.');
                } else {
                    // Crear nuevo pedido
                    const newOrder = {
                        id: Date.now().toString(),
                        createdAt: new Date().toISOString(),
                        ...orderData
                    };
                    orders.push(newOrder);
                    showStatusMessage('Pedido agregado correctamente.');
                }
                
                saveOrders();
                renderOrders(orders);
                resetForm();
            };
            
            const resetForm = () => {
                orderForm.reset();
                editingOrderId = null;
                submitButton.textContent = 'Agregar Pedido';
                submitButton.classList.remove('bg-green-600', 'hover:bg-green-700');
                submitButton.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            };

            // Manejar click en la tabla (para editar o eliminar)
            const handleTableClick = (e) => {
                const target = e.target;
                const id = target.dataset.id;
                if (!id) return;

                if (target.classList.contains('edit-btn')) {
                    handleEdit(id);
                } else if (target.classList.contains('delete-btn')) {
                    showConfirmationModal(() => {
                       handleDelete(id);
                    }, '¿Estás seguro de que quieres eliminar este pedido?');
                }
            };

            // Preparar formulario para editar un pedido
            const handleEdit = (id) => {
                const orderToEdit = orders.find(order => order.id === id);
                if (!orderToEdit) return;

                document.getElementById('nroPedido').value = orderToEdit.nroPedido;
                document.getElementById('descripcion').value = orderToEdit.descripcion;
                document.getElementById('cantidad').value = orderToEdit.cantidad;
                document.getElementById('observacion').value = orderToEdit.observacion;

                editingOrderId = id;
                submitButton.textContent = 'Actualizar Pedido';
                submitButton.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                submitButton.classList.add('bg-green-600', 'hover:bg-green-700');
                window.scrollTo(0, 0); // Ir al inicio de la página para ver el formulario
            };

            // Eliminar un pedido
            const handleDelete = (id) => {
                orders = orders.filter(order => order.id !== id);
                saveOrders();
                renderOrders(getFilteredOrders());
                showStatusMessage('Pedido eliminado.', 'error');
            };
            
            // Filtrar pedidos según la búsqueda
            const getFilteredOrders = () => {
                const searchTerm = searchInput.value.toLowerCase();
                if (!searchTerm) return orders;
                
                return orders.filter(order => 
                    order.nroPedido.toLowerCase().includes(searchTerm) ||
                    order.descripcion.toLowerCase().includes(searchTerm)
                );
            };

            // Manejar la búsqueda
            const handleSearch = () => {
                renderOrders(getFilteredOrders());
            };
            
            // Limpiar todos los pedidos
            const clearAllOrders = () => {
                orders = [];
                saveOrders();
                renderOrders(orders);
                showStatusMessage('Todos los pedidos han sido eliminados.', 'error');
            };

            // Exportar a PDF
            const exportToPdf = () => {
                const { jsPDF } = window.jspdf;
                if (typeof jsPDF === 'undefined') {
                    showStatusMessage('Error al cargar la librería PDF.', 'error');
                    return;
                }
                const doc = new jsPDF();
                
                const tableData = getFilteredOrders().map(order => [
                    order.nroPedido,
                    order.descripcion,
                    order.cantidad,
                    order.observacion || '-',
                    new Date(order.createdAt).toLocaleDateString()
                ]);

                doc.autoTable({
                    head: [['Nro de Pedido', 'Descripción', 'Cantidad', 'Observación', 'Fecha de Creación']],
                    body: tableData,
                    startY: 20,
                    theme: 'grid',
                    headStyles: { fillColor: [74, 85, 224] }, // Color índigo
                });

                doc.text("Solicitud de Pedidos", 14, 15);
                doc.save(`pedidos_${new Date().toISOString().slice(0,10)}.pdf`);
            };

            // --- Lógica del Modal ---
            const showConfirmationModal = (action, message) => {
                actionToConfirm = action;
                modalMessage.textContent = message;
                confirmationModal.classList.remove('hidden');
                // Forzamos un reflow para que la animación se ejecute
                void confirmationModal.offsetWidth;
                confirmationModal.querySelector('div').classList.add('fade-in');
            };

            const hideConfirmationModal = () => {
                const modalContent = confirmationModal.querySelector('div');
                modalContent.classList.remove('fade-in');
                modalContent.classList.add('fade-out');
                setTimeout(() => {
                    confirmationModal.classList.add('hidden');
                    modalContent.classList.remove('fade-out');
                    actionToConfirm = null;
                }, 300); // Duración de la animación
            };
            
            confirmButton.addEventListener('click', () => {
                if (typeof actionToConfirm === 'function') {
                    actionToConfirm();
                }
                hideConfirmationModal();
            });

            cancelButton.addEventListener('click', hideConfirmationModal);
            
            // EVENT LISTENERS
            orderForm.addEventListener('submit', handleFormSubmit);
            ordersTableBody.addEventListener('click', handleTableClick);
            searchInput.addEventListener('input', handleSearch);
            exportPdfBtn.addEventListener('click', exportToPdf);
            clearAllBtn.addEventListener('click', () => {
                if (orders.length > 0) {
                    showConfirmationModal(clearAllOrders, '¿Estás seguro de que quieres eliminar TODOS los pedidos? Esta acción no se puede deshacer.');
                } else {
                    showStatusMessage('No hay pedidos para eliminar.', 'error');
                }
            });

            // CARGA INICIAL
            loadOrders();
        });
    </script>
</body>
</html>
